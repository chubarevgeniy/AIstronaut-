name: Godot Android Build

on:
  push:
    branches:
      - main
      - master
      - godot-port*
  pull_request:
    paths:
      - 'godot_project/**'
      - '.github/workflows/godot-android.yml'

jobs:
  export-android:
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.2.1
    env:
      GODOT_VERSION: 4.2.1
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Godot
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates/
          if [ ! -d ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable ]; then
            if [ -d /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ]; then
              cp -r /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/
            else
              echo "Templates not found in /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable"
              exit 1
            fi
          fi

      - name: Setup Android Keystore
        run: |
          keytool -keyalg RSA -genkeypair -alias androiddebugkey -keypass android -keystore debug.keystore -storepass android -dname "CN=Android Debug,O=Android,C=US" -validity 9999
          mv debug.keystore godot_project/debug.keystore

      - name: Validate Export Environment
        run: |
          chmod +x godot_project/scripts/validate_export_env.sh
          ./godot_project/scripts/validate_export_env.sh

      - name: Configure Editor Settings for Android
        run: |
          chmod +x godot_project/scripts/generate_editor_settings.sh
          ./godot_project/scripts/generate_editor_settings.sh "${GITHUB_WORKSPACE}/godot_project/debug.keystore" "androiddebugkey" "android"

      - name: Build
        run: |
          cd godot_project
          mkdir -p build/android
          godot --headless --verbose --export-debug "Android" build/android/aistronaut-debug.apk
          echo "Build finished. Checking output directory:"
          ls -R build/android

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-debug-apk
          path: godot_project/build/android/aistronaut-debug.apk
